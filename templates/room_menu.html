{% extends "base.html" %}

{% block content %}
<div class="container">
    <h2>{{ room.name }} / ì„ íƒëœ ì¹´í˜: {{ room.cafe }}</h2>

    {% if not guest_name %}
    <form id="guestNameForm">
        {% csrf_token %}
        <input type="text" name="guest_name" required placeholder="ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”">
        <button type="submit">ì…ì¥</button>
    </form>
    {% else %}
    <p>ì•ˆë…•í•˜ì„¸ìš”, {{ guest_name }}ë‹˜!</p>

    <form id="menuForm">
        {% csrf_token %}
        <button type="submit" id="confirmButton" disabled>ì£¼ë¬¸ í™•ì •í•˜ê¸°</button>
    </form>

    <div id="menuListContainer" class="menu-grid">
        {% for menu in menus %}
        <div class="menu-item" data-menu-id="{{ menu.id }}">
            {% if menu.image_url %}
                <img src="{{ menu.image_url }}" alt="{{ menu.name }}" class="menu-image">
            {% endif %}
            <p class="menu-name">{{ menu.name }}</p>
        </div>
        {% endfor %}
    </div>

    <!-- Modal -->
    <div class="modal" id="menuDetailModal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <h2 id="menuDetailModalLabel"></h2>
            <img id="modalMenuImage" src="" alt="" class="menu-image">
            <div class="btn-group">
                <button type="button" class="btn" id="hotButton">ğŸ”¥ HOT</button>
                <button type="button" class="btn" id="iceButton">ğŸ§Š ICE</button>
            </div>
            <div class="btn-group">
                <button type="button" class="btn" id="regularButton">Regular</button>
                <button type="button" class="btn" id="extraButton">Extra</button>
            </div>
            <div class="btn-group">
                <button type="button" class="btn" id="noSyrupButton">ì–¼ìŒ ë§ì´</button>
                <button type="button" class="btn" id="lessSyrupButton">ì–¼ìŒ ë³´í†µ</button>
                <button type="button" class="btn" id="regularSyrupButton">ì–¼ìŒ ì ê²Œ</button>
            </div>
            <div class="form-group">
                <label for="additionalInstructions">ê¸°íƒ€ ì„¸ë¶€ì‚¬í•­:</label>
                <textarea id="additionalInstructions" rows="3"></textarea>
            </div>
            <button type="button" id="saveMenuItem">ë‚´ ë©”ë‰´ ì €ì¥í•˜ê¸°</button>
        </div>
    </div>

    {% endif %}
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const guestNameForm = document.getElementById('guestNameForm');
    if (guestNameForm) {
        guestNameForm.addEventListener('submit', handleGuestNameSubmit);
    } else {
        setupMenuInteractions();
    }
});

function handleGuestNameSubmit(e) {
    e.preventDefault();
    const formData = new FormData(e.target);
    fetch(window.location.href, {
        method: 'POST',
        body: formData,
        headers: {
            'X-CSRFToken': formData.get('csrfmiddlewaretoken')
        }
    })
    .then(response => {
        if (!response.ok) {
            return response.text().then(text => {
                throw new Error('Server error: ' + text);
            });
        }
        return response.json();
    })
    .then(data => {
        if (data.success) {
            location.reload();
        } else {
            throw new Error(data.error || 'Unknown error occurred');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('An error occurred: ' + error.message);
    });
}

function setupMenuInteractions() {
    const menuItems = document.querySelectorAll('.menu-item');
    const modal = document.getElementById('menuDetailModal');
    const modalTitle = document.getElementById('menuDetailModalLabel');
    const modalImage = document.getElementById('modalMenuImage');
    const saveMenuItem = document.getElementById('saveMenuItem');
    const closeBtn = modal.querySelector('.close');
    const confirmButton = document.getElementById('confirmButton');
    const selectedMenus = new Set();

    menuItems.forEach(item => {
        item.addEventListener('click', function() {
            const menuId = this.getAttribute('data-menu-id');
            const menuName = this.querySelector('.menu-name').textContent;
            const menuImageSrc = this.querySelector('.menu-image')?.src;

            modalTitle.textContent = menuName;
            if (menuImageSrc) {
                modalImage.src = menuImageSrc;
                modalImage.style.display = 'block';
            } else {
                modalImage.style.display = 'none';
            }
            modal.style.display = 'block';
            saveMenuItem.setAttribute('data-menu-id', menuId);
        });
    });

    closeBtn.onclick = function() {
        modal.style.display = 'none';
    }

    window.onclick = function(event) {
        if (event.target == modal) {
            modal.style.display = 'none';
        }
    }

    saveMenuItem.addEventListener('click', function() {
        const menuId = this.getAttribute('data-menu-id');
        const temperature = document.querySelector('#hotButton.active, #iceButton.active') ? document.querySelector('#hotButton.active, #iceButton.active').textContent.trim() : '';
        const size = document.querySelector('#regularButton.active, #extraButton.active') ? document.querySelector('#regularButton.active, #extraButton.active').textContent.trim() : '';
        const ice = document.querySelector('#noSyrupButton.active, #lessSyrupButton.active, #regularSyrupButton.active') ? document.querySelector('#noSyrupButton.active, #lessSyrupButton.active, #regularSyrupButton.active').textContent.trim() : '';
        const instructions = document.getElementById('additionalInstructions').value;

        selectedMenus.add({
            id: menuId,
            options: { temperature, size, ice, instructions }
        });

        updateButtonState();
        modal.style.display = 'none';
    });

    const menuForm = document.getElementById('menuForm');
    menuForm.addEventListener('submit', function(e) {
        e.preventDefault();
        if (selectedMenus.size === 0) {
            alert('ìµœì†Œ í•˜ë‚˜ì˜ ë©”ë‰´ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.');
            return;
        }

        const formData = new FormData(menuForm);
        formData.append('menus', JSON.stringify(Array.from(selectedMenus)));

        fetch(window.location.href, {
            method: 'POST',
            body: formData,
            headers: {
                'X-CSRFToken': formData.get('csrfmiddlewaretoken')
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success && data.redirect_url) {
                window.location.href = data.redirect_url;
            }
        });
    });

    function updateButtonState() {
        confirmButton.disabled = selectedMenus.size === 0;
    }

    function toggleButtonActive(button) {
        button.classList.toggle('active');
    }

    ['hotButton', 'iceButton'].forEach(id => {
        document.getElementById(id).addEventListener('click', function() {
            ['hotButton', 'iceButton'].forEach(btnId => {
                document.getElementById(btnId).classList.remove('active');
            });
            toggleButtonActive(this);
        });
    });

    ['regularButton', 'extraButton'].forEach(id => {
        document.getElementById(id).addEventListener('click', function() {
            ['regularButton', 'extraButton'].forEach(btnId => {
                document.getElementById(btnId).classList.remove('active');
            });
            toggleButtonActive(this);
        });
    });

    ['noSyrupButton', 'lessSyrupButton', 'regularSyrupButton'].forEach(id => {
        document.getElementById(id).addEventListener('click', function() {
            ['noSyrupButton', 'lessSyrupButton', 'regularSyrupButton'].forEach(btnId => {
                document.getElementById(btnId).classList.remove('active');
            });
            toggleButtonActive(this);
        });
    });
}
</script>
{% endblock %}

{% block extra_css %}

<style>
.modal {
    display: none;
    position: fixed;
    z-index: 1;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    overflow: auto;
    background-color: rgba(0,0,0,0.4);
}

.modal-content {
    background-color: #fefefe;
    margin: 15% auto;
    padding: 20px;
    border: 1px solid #888;
    width: 80%;
    max-width: 500px;
}

.close {
    color: #aaa;
    float: right;
    font-size: 28px;
    font-weight: bold;
}

.close:hover,
.close:focus {
    color: black;
    text-decoration: none;
    cursor: pointer;
}

.btn-group {
    display: flex;
    justify-content: space-between;
    margin-bottom: 10px;
}

.btn {
    padding: 10px;
    border: 1px solid #ddd;
    background-color: #f8f9fa;
    cursor: pointer;
}

.btn.active {
    background-color: #007bff;
    color: white;
}

#additionalInstructions {
    width: 100%;
    margin-bottom: 10px;
}

#saveMenuItem {
    display: block;
    width: 100%;
    padding: 10px;
    background-color: #28a745;
    color: white;
    border: none;
    cursor: pointer;
}

.menu-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
    gap: 20px;
}

.menu-item {
    border: 1px solid #ddd;
    padding: 10px;
    text-align: center;
    cursor: pointer;
}

.menu-image {
    max-width: 100%;
    height: auto;
}
</style>
{% endblock %}